import React, { useState } from 'react';
import Layout from '../components/Layout';
import Card from '../components/Card';
import FormField from '../components/FormField';
import Button from '../components/Button';
import { useAssessment } from '../contexts/AssessmentContext';
import { calculateRisk } from '../utils/riskCalculation';

export default function BiopsychosocialFactorsPage() {
  const { state, dispatch } = useAssessment();
  const [factors, setFactors] = useState({
    biological: {
      pastBackPain: false,
      exerciseHabit: false,
      goodSleep: false,
      noFatigue: false,
      stableWeight: false,
      noSmoking: false,
      normalWorkHours: false,
      noHeavyLifting: false,
      variablePosture: false,
      noTwistingBending: false,
    },
    psychological: {
      lowStress: false,
      goodRelationships: false,
      jobSatisfaction: false,
      manageableWorkload: false,
      goodMentalHealth: false,
    },
    social: {
      familySupport: false,
      workAutonomy: false,
      adequateWorkspace: false,
      variedTasks: false,
      safeEnvironment: false,
    },
  });

  const biologicalQuestions = [
    { key: 'pastBackPain', text: '過去に腰痛の経験はありませんか？' },
    { key: 'exerciseHabit', text: '定期的な運動習慣がありますか？' },
    { key: 'goodSleep', text: '十分な睡眠を取れていますか？' },
    { key: 'noFatigue', text: '慢性的な疲労感はありませんか？' },
    { key: 'stableWeight', text: '体重は安定していますか？' },
    { key: 'noSmoking', text: '喫煙はしていませんか？' },
    { key: 'normalWorkHours', text: '適切な労働時間ですか？' },
    { key: 'noHeavyLifting', text: '重い物を持ち上げる作業はありませんか？' },
    { key: 'variablePosture', text: '作業姿勢は変化に富んでいますか？' },
    { key: 'noTwistingBending', text: '体をひねったり曲げたりする作業はありませんか？' }
  ];

  const psychologicalQuestions = [
    { key: 'lowStress', text: 'ストレスレベルは低いですか？' },
    { key: 'goodRelationships', text: '良好な人間関係を築けていますか？' },
    { key: 'jobSatisfaction', text: '仕事に満足していますか？' },
    { key: 'manageableWorkload', text: '仕事量は管理可能ですか？' },
    { key: 'goodMentalHealth', text: '精神的に健康ですか？' }
  ];

  const socialQuestions = [
    { key: 'familySupport', text: '家族のサポートがありますか？' },
    { key: 'workAutonomy', text: '仕事に自主性がありますか？' },
    { key: 'adequateWorkspace', text: '適切な作業スペースがありますか？' },
    { key: 'variedTasks', text: '多様なタスクがありますか？' },
    { key: 'safeEnvironment', text: '安全な作業環境ですか？' }
  ];

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    const existingLowBackPain = state.data.lowBackPain || {};
    const updatedData = { 
      lowBackPain: { 
        ...existingLowBackPain, 
        biopsychosocial: factors 
      } 
    };
    
    dispatch({ type: 'UPDATE_DATA', payload: updatedData });

    // Calculate results
    const results = calculateRisk({ ...state.data, ...updatedData });
    dispatch({ type: 'SET_RESULTS', payload: results });
  };

  const handleFactorChange = (
    category: 'biological' | 'psychological' | 'social',
    key: string,
    value: boolean
  ) => {
    setFactors({
      ...factors,
      [category]: {
        ...factors[category],
        [key]: value
      }
    });
  };

  return (
    <Layout title="生物心理社会的要因">
      <Card>
        <form onSubmit={handleSubmit} className="space-y-8">
          {/* Biological Factors */}
          <div>
            <h3 className="text-lg font-semibold text-gray-900 mb-4">生物学的要因</h3>
            <div className="space-y-4">
              {biologicalQuestions.map((question, index) => (
                <FormField key={question.key} label={`${index + 1}. ${question.text}`}>
                  <div className="flex space-x-6">
                    <label className="flex items-center space-x-2 cursor-pointer">
                      <input
                        type="radio"
                        checked={factors.biological[question.key as keyof typeof factors.biological] === true}
                        onChange={() => handleFactorChange('biological', question.key, true)}
                        className="w-4 h-4 text-blue-600"
                      />
                      <span>はい</span>
                    </label>
                    <label className="flex items-center space-x-2 cursor-pointer">
                      <input
                        type="radio"
                        checked={factors.biological[question.key as keyof typeof factors.biological] === false}
                        onChange={() => handleFactorChange('biological', question.key, false)}
                        className="w-4 h-4 text-blue-600"
                      />
                      <span>いいえ</span>
                    </label>
                  </div>
                </FormField>
              ))}
            </div>
          </div>

          {/* Psychological Factors */}
          <div>
            <h3 className="text-lg font-semibold text-gray-900 mb-4">心理的要因</h3>
            <div className="space-y-4">
              {psychologicalQuestions.map((question, index) => (
                <FormField key={question.key} label={`${index + 1}. ${question.text}`}>
                  <div className="flex space-x-6">
                    <label className="flex items-center space-x-2 cursor-pointer">
                      <input
                        type="radio"
                        checked={factors.psychological[question.key as keyof typeof factors.psychological] === true}
                        onChange={() => handleFactorChange('psychological', question.key, true)}
                        className="w-4 h-4 text-blue-600"
                      />
                      <span>はい</span>
                    </label>
                    <label className="flex items-center space-x-2 cursor-pointer">
                      <input
                        type="radio"
                        checked={factors.psychological[question.key as keyof typeof factors.psychological] === false}
                        onChange={() => handleFactorChange('psychological', question.key, false)}
                        className="w-4 h-4 text-blue-600"
                      />
                      <span>いいえ</span>
                    </label>
                  </div>
                </FormField>
              ))}
            </div>
          </div>

          {/* Social Factors */}
          <div>
            <h3 className="text-lg font-semibold text-gray-900 mb-4">社会的要因</h3>
            <div className="space-y-4">
              {socialQuestions.map((question, index) => (
                <FormField key={question.key} label={`${index + 1}. ${question.text}`}>
                  <div className="flex space-x-6">
                    <label className="flex items-center space-x-2 cursor-pointer">
                      <input
                        type="radio"
                        checked={factors.social[question.key as keyof typeof factors.social] === true}
                        onChange={() => handleFactorChange('social', question.key, true)}
                        className="w-4 h-4 text-blue-600"
                      />
                      <span>はい</span>
                    </label>
                    <label className="flex items-center space-x-2 cursor-pointer">
                      <input
                        type="radio"
                        checked={factors.social[question.key as keyof typeof factors.social] === false}
                        onChange={() => handleFactorChange('social', question.key, false)}
                        className="w-4 h-4 text-blue-600"
                      />
                      <span>いいえ</span>
                    </label>
                  </div>
                </FormField>
              ))}
            </div>
          </div>

          <div className="flex justify-end pt-4">
            <Button type="submit" size="lg">
              結果を表示
            </Button>
          </div>
        </form>
      </Card>
    </Layout>
  );
}
